\documentclass{article}
\usepackage[french]{babel} % Pour le français
\usepackage{hyperref} % Pour les liens

\title{Amélioration de la fonction \texttt{predict\_response\_c}}
\author{Ton Nom}
\date{\today}

\usepackage{Sweave}
\begin{document}
\input{rapport-concordance}

\maketitle

\section{Introduction}
Ce document décrit la correction apportée au package pour améliorer la gestion des valeurs manquantes lors du calcul des prédictions à partir d'un modèle \texttt{svyglm}.
L'utilisateur signalait que l'utilisation d'un \texttt{newdata} contenant des valeurs manquantes entraînait des erreurs ou des résultats incorrects.

\section{Problème rencontré}
L'utilisateur rencontrait le problème suivant :
\begin{itemize}
  \item Lorsque \texttt{newdata} contenait des valeurs manquantes, les poids n'étaient pas correctement pris en compte.
  \item Dans une ancienne version du package, une erreur était levée, ce qui était plus sûr que d'obtenir des résultats erronés.
  \item La solution manuelle était de supprimer les valeurs manquantes avant d'appeler la fonction, ce qui était fastidieux.
\end{itemize}

\section{Correction apportée}
Nous avons modifié la fonction \texttt{predict\_response\_c} pour :
\begin{itemize}
  \item Filtrer automatiquement \texttt{newdata} pour supprimer les lignes contenant des valeurs manquantes.
  \item Ajouter un message informatif lorsque des lignes sont supprimées.
  \item Permettre d'utiliser un paramètre \texttt{na.action} pour choisir le comportement :
    \begin{itemize}
      \item \texttt{"omit"} (par défaut) : supprime les lignes avec valeurs manquantes.
      \item \texttt{"fail"} : génère une erreur si des valeurs manquantes sont détectées.
    \end{itemize}
\end{itemize}

\section{Code mis à jour}
Voici la nouvelle version de la fonction :

\begin{Schunk}
\begin{Sinput}
\begin{Schunk}
\begin{Sinput}
> predict_response_c <- function(model, terms, margin = "mean_reference", ci_level = 0.95,
+                              type = "fixed", condition = NULL, interval = "confidence",
+                              back_transform = TRUE, vcov = NULL, vcov_args = NULL, weights = NULL,
+                              bias_correction = FALSE, verbose = TRUE, na.rm = FALSE, na.action = "omit", ...)
+ {
+   margin <- getOption("ggeffects_margin", margin)
+   margin <- insight::validate_argument(argument = margin, options = c("mean_reference",
+                                                                       "mean_mode", "marginalmeans", "empirical", "counterfactual",
+                                                                       "full_data", "average", "marginaleffects"))
+   model_name <- insight::safe_deparse(substitute(model))
+   type <- insight::validate_argument(type, c("fixed", "random", "response", "link"))
+   interval <- insight::validate_argument(interval, c("confidence", "prediction"))
+ 
+   # Capture des arguments supplémentaires
+   dots <- list(...)
+   newdata <- dots$newdata
+ 
+   # Vérification et traitement des valeurs manquantes
+   if (!is.null(newdata)) {
+     predictor_names <- insight::find_predictors(model)$conditional
+     required_vars <- c(predictor_names, weights)
+     newdata <- newdata[, required_vars, drop = FALSE]
+     missing_mask <- !complete.cases(newdata)
+ 
+     if (any(missing_mask)) {
+       if (na.action == "omit") {
+         message(sprintf("⚠️ Attention : %d lignes de `newdata` contenant des valeurs manquantes ont été supprimées.", sum(missing_mask)))
+         newdata <- newdata[!missing_mask, , drop = FALSE]
+       } else if (na.action == "fail") {
+         stop("Erreur : `newdata` contient des valeurs manquantes. Veuillez les traiter avant de continuer.")
+       }
+     }
+   }
+ 
+   dots$newdata <- newdata  # Ajout de newdata dans dots
+ 
+   out <- switch(margin,
+                 mean_reference = ggpredict(model, terms = terms, ci_level = ci_level,
+                                            type = type, typical = "mean", condition = condition,
+                                            back_transform = back_transform, vcov = vcov, vcov_args = vcov_args,
+                                            interval = interval, bias_correction = bias_correction,
+                                            verbose = verbose, ...),
+                 empirical = ggaverage(model, terms = terms, ci_level = ci_level, type = type,
+                                       typical = "mean", condition = condition, back_transform = back_transform,
+                                       vcov = vcov, vcov_args = vcov_args, weights = weights,
+                                       verbose = verbose, newdata = newdata, ...))
+ 
+   attr(out, "model.name") <- model_name
+   out
+ }
\end{Sinput}
\end{Schunk}
\end{Sinput}
\end{Schunk}

\section{Conclusion}
Grâce à cette modification, la fonction \texttt{predict\_response\_c} gère désormais mieux les valeurs manquantes en les supprimant automatiquement ou en affichant un message d'erreur si l'utilisateur préfère ce comportement.
Cela permet d'éviter les erreurs silencieuses et d'améliorer la fiabilité des prédictions.

\end{document}
